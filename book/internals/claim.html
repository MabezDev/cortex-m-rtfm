<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>claim - The RTFM book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="_FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="preface.html"><strong aria-hidden="true">1.</strong> Preface</a></li><li><a href="user/guide.html"><strong aria-hidden="true">2.</strong> User guide</a></li><li><ol class="section"><li><a href="user/basic.html"><strong aria-hidden="true">2.1.</strong> Basic organization</a></li><li><a href="user/events.html"><strong aria-hidden="true">2.2.</strong> Reacting to events</a></li><li><a href="user/state.html"><strong aria-hidden="true">2.3.</strong> Adding state</a></li><li><ol class="section"><li><a href="user/late-resources.html"><strong aria-hidden="true">2.3.1.</strong> Runtime initialized resources</a></li></ol></li><li><a href="user/messages.html"><strong aria-hidden="true">2.4.</strong> Message passing</a></li><li><a href="user/scheduling.html"><strong aria-hidden="true">2.5.</strong> Priority based scheduling</a></li><li><a href="user/sharing.html"><strong aria-hidden="true">2.6.</strong> Resource sharing</a></li><li><a href="user/pools.html"><strong aria-hidden="true">2.7.</strong> Object pools</a></li><li><a href="user/periodic.html"><strong aria-hidden="true">2.8.</strong> Periodic tasks</a></li></ol></li><li><a href="internals.html"><strong aria-hidden="true">3.</strong> Under the hood</a></li><li><ol class="section"><li><a href="internals/scheduler.html"><strong aria-hidden="true">3.1.</strong> The scheduler</a></li><li><a href="internals/claim.html" class="active"><strong aria-hidden="true">3.2.</strong> claim</a></li><li><a href="internals/messages.html"><strong aria-hidden="true">3.3.</strong> Message passing</a></li><li><ol class="section"><li><a href="internals/dispatcher.html"><strong aria-hidden="true">3.3.1.</strong> Dispatching tasks</a></li><li><a href="internals/schedule-now.html"><strong aria-hidden="true">3.3.2.</strong> schedule_now</a></li><li><a href="internals/capacity.html"><strong aria-hidden="true">3.3.3.</strong> Capacity</a></li></ol></li><li><a href="internals/tq.html"><strong aria-hidden="true">3.4.</strong> The timer queue</a></li><li><ol class="section"><li><a href="internals/tq/schedule-after.html"><strong aria-hidden="true">3.4.1.</strong> schedule_after</a></li><li><a href="internals/tq/handler.html"><strong aria-hidden="true">3.4.2.</strong> The timer queue handler</a></li></ol></li><li><a href="internals/ceilings.html"><strong aria-hidden="true">3.5.</strong> Ceiling analysis</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The RTFM book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="internals/claim.html#claim" id="claim"><h1><code>claim</code></h1></a>
<p>At the center of RTFM we have the <code>Resource</code> abstraction. A <code>Resource</code> is a mechanism to share data
between two or more tasks (contexts of execution) that can potentially run at different priorities.
When tasks have different priorities they can preempt each other and this can lead to data races if
the access to the data is <em>not</em> synchronized. A <code>Resource</code> eliminates the data race problem by
forcing the tasks to access the data through a critical section. While in a critical section the
other tasks that share the <code>Resource</code> can <em>not</em> start.</p>
<p>As tasks in RTFM are all dispatched in interrupt handlers one way to create a critical section is to
disable all interrupts (<code>cpsid i</code> instruction). However, this approach also prevents tasks that are
not contending for the resource from starting, which can reduce the responsiveness of the system.
The Cortex-M implementation uses priority based critical sections (AKA Priority Ceiling Protocol) to
avoid this problem, or at least to reduce its effect.</p>
<p>The NVIC, which is the core of the RTFM scheduler, supports dynamic reprioritization of interrupts
via the <a href="https://developer.arm.com/products/architecture/m-profile/docs/100701/latest/special-purpose-mask-registers">BASEPRI</a> register. By writing to this register we can increase the priority of the current
interrupt / task preventing tasks with lower priority from starting. A temporal increase of the
priority can be used as a critical section; this is how <code>claim</code> works in the Cortex-M implementation
of RTFM.</p>
<p>The question is how much to increase the priority in these critical sections? The value must be high
enough to prevent data races but not too high that it blocks unrelated tasks. The answer to this
question comes from the Priority Ceiling Protocol: each resource has a priority <em>ceiling</em>; to access
the data a critical section must be created by temporarily increasing the priority to match the
priority ceiling; the priority ceiling of a resource is equal to the priority of the highest
priority task that can access the resource.</p>
<p>In the Cortex-M implementation of RTFM we store the ceiling of a resource in the type system and we
also track the dynamic priority of a task using the type system. The main reason for this is
generating optimal machine code for <code>claim</code>s.</p>
<p>Here's what the <code>Resource</code> abstraction looks like:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
/// Priority token
pub struct Priority&lt;P&gt; { _not_send_or_sync: *const (), _priority: PhantomData&lt;P&gt; }

pub unsafe trait Resource {
    /// The number of priority bits supported by the NVIC (device specific)
    const NVIC_PRIO_BITS: u8;

    /// The priority &quot;ceiling&quot; of this resource
    type Ceiling: Unsigned; // type level integer (cf. typenum)

    /// The data protected by this resource
    type Data: 'static + Send;

    // Returns a reference to the `static mut` variable protected by this resource
    #[doc(hidden)]
    unsafe fn _var() -&gt; &amp;'static mut Self::Data;

    /// Borrows the resource data while the priority is high enough
    // NOTE there's a mutable version of this method: `borrow_mut`
    fn borrow&lt;P, 'p&gt;(&amp;'t self, p: &amp;'p Priority&lt;P&gt;) -&gt; &amp;'p Self::Data
    where
        P: IsGreaterOrEqual&lt;Self::Ceiling, Output = True&gt;,
    {
        unsafe { Self::_var() }
    }

    /// Claim the data proceted by this resource
    // NOTE there's a mutable version of this method: `claim_mut`
    fn claim&lt;P&gt;(&amp;self, t: &amp;mut Priority&lt;P&gt;, f: F)
    where
        F: FnOnce(&amp;Self::Data, &amp;mut Priority&lt;Maximum&lt;P, Self::Ceiling&gt;)
        P: Max&lt;Self::Ceiling&gt; + Unsigned,
        Self::Ceiling: Unsigned,
    {
        unsafe {
            if P::to_u8() &gt;= Self::Ceiling::to_u8() {
                // the priority doesn't need to be raised further
                f(Self::get(), &amp;mut Priority::new())
            } else {
                // the hardware priority ceiling of this resource
                let new = (1 &lt;&lt; Self::NVIC_PRIO_BITS - Self::Ceiling::to_u8()) &lt;&lt;
                    (8 - Self::NVIC_PRIO_BITS);

                let old = basepri::read();

                // start the critical section by raising the dynamic priority
                basepri::write(new);

                // execute user provided code inside the critical section
                let r = f(Self::get(), &amp;mut Priority::new());

                // end the critical section by restoring the old dynamic priority
                basepri::write(old);

                r
            }
        }
    }
}
#}</code></pre></pre>
<p>The <code>Priority</code> <em>token</em> is used to track the current dynamic priority of a task. When a task starts
its <code>Context</code> contains a <code>Priority</code> token that represents the priority declared in <code>app!</code>. For
example, if the task priority was set to <code>2</code> the threshold token will have type <code>Threshold&lt;U2&gt;</code>
where <code>U2</code> is the type level version of <code>2</code> (cf. <a href="https://docs.rs/typenum"><code>typenum</code></a>).</p>
<p>The <code>claim</code> method creates a critical section by temporarily raising the task priority. Within this
critical section (closure) a new <code>Priority</code> token is provided while the outer <code>Priority</code> token is
invalidated due to borrow semantics (mutably borrowed / frozen).</p>
<p>When generating code the <code>app!</code> macro creates a <code>struct</code> that implements the <code>Resource</code> trait for
each resource declared in <code>resources</code>. The data behind each <code>Resource</code> is a <code>static mut</code> variable:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// given: `resources: { static FOO: u32 = 0 }`

// app! produces
mod __resource {
    pub struct FOO { _not_send_or_sync: *const () }

    unsafe impl Resource for FOO {
        const NVIC_PRIO_BITS = stm32f103xx::NVIC_PRIO_BITS;

        type Ceiling = U3;

        type Data = u32;

        unsafe fn _var() -&gt; &amp;'static mut u32 {
            static mut FOO: u32 = 0;

            &amp;mut FOO
        }
    }
}
#}</code></pre></pre>
<p>Theses resource <code>struct</code> are packed in <code>Resources</code> <code>struct</code>s and then placed in the <code>Context</code> of
each task.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// given: `tasks: { a: { resources: [FOO, BAR] } }`

// app! produces
mod a {
    pub struct Context {
        pub resources: Resources,
        // ..
    }

    pub struct Resources {
        pub FOO: __resource::FOO,
        pub BAR: __resource::BAR,
    }
}
#}</code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="internals/scheduler.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="internals/messages.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="internals/scheduler.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="internals/messages.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

    </body>
</html>
